<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Stateful NAT64 - Ejemplo de uso</title>
	<link href="../css/style.css" rel="stylesheet" type="text/css" media="screen" />
	<link href="../css/print.css" rel="stylesheet" type="text/css" media="print" />
</head>

<body>
	<div id="page">
		<div id="contentwrapper">
			<div id="sidebar_navigation" class="sidebar">
				<div class="left_sidebar_menu">
					<div class="left_sidebar_menu_button">
						<a href="index.html">Inicio</a>
					</div>
					<div class="left_sidebar_menu_selected">
						<a href="documentation.html">Documentación</a>
					</div>
					<div class="left_sidebar_menu_button">
						<a href="download.html">Descargar</a>
					</div>
					<div class="left_sidebar_menu_button">
						<a href="faq.html">FAQ</a>
					</div>
					<div class="left_sidebar_menu_button">
						<a href="https://github.com/NICMx/NAT64/issues" target="_blank">
							Reportar un Bug
						</a>
					</div>
					<div class="left_sidebar_menu_button">
						<a href="about.html">Acerca de ...</a>
					</div>
					<div class="left_sidebar_menu_button">
						<a href="contact.html">Contacto</a>
					</div>
				</div>
			</div>
			<div id="content">
				<div class="worklogo">
					<a href="index.html"><img src="../images/jool.png" alt="logo-jool" /></a>
				</div>
				<div class="workarea">
					<div class="content_text">

<p><a href="documentation.html">Documentación</a> &gt; <a href="documentation.html#ejemplos-de-uso">Ejemplos de uso</a> &gt; Stateful NAT64</p>

<h1 id="stateful-nat64-ejemplo-de-uso">Stateful NAT64: Ejemplo de Uso</h1>

<h2 id="ndice">Índice</h2>

<ol>
  <li><a href="#introduccin">Introducción</a></li>
  <li><a href="#red-de-ejemplo">Red de ejemplo</a><br />
 a) <a href="#configuracin-de-nodos-en-ipv6">Configuración de Nodos en IPv6</a><br />
 b) <a href="#configuracin-de-nodos-en-ipv4">Configuración de Nodos en IPv4</a><br />
 c) <a href="#configuracin-del-nodo-traductor">Configuración del Nodo Traductor</a></li>
  <li><a href="#jool">Jool</a></li>
  <li><a href="#pruebas">Pruebas</a><br />
 a) <a href="#conectividad-de-ipv6-a-ipv4">Conectividad de IPv6 a IPv4</a><br />
 b) <a href="#conectividad-a-un-web-server-en-ipv4">Conectividad a un Web Server en IPv4</a></li>
  <li><a href="#deteniendo-jool">Deteniendo Jool</a></li>
  <li><a href="#lecturas-adicionales">Lecturas adicionales</a></li>
</ol>

<h2 id="introduccin">Introducción</h2>

<p>Este documento explica como ejecutar Jool en modo Stateful NAT64. Si no tienes nociones de este tipo de traducción ingresa a <a href="intro-nat64.html#stateful-nat64">Stateful NAT64</a>.</p>

<p>Similar a los modos anteriores, solo necesitas una instalación exitosa de del <a href="mod-install.html">Servidor Jool</a>. El Configurador no se necesita en esta ejecución básica.</p>

<h2 id="red-de-ejemplo">Red de ejemplo</h2>

<p><img src="../images/network/stateful.svg" alt="Figura 1 - Red de ejemplo" /></p>

<p>Aquí también, son válidas y aplican las observaciones mencionadas de la <a href="mod-run-vanilla.html#red-de-ejemplo">sección Red de Ejemplo para SIIT</a> exceptuando dos: el del uso de direcciones en el segmento 198.51.100.8/29 y el default gateway. Resumiéndolas, tenemos que:</p>

<ul>
  <li>Al menos necesitarás tres nodos: <em>A</em>, <em>V</em> y <em>T</em>.</li>
  <li>Jool requiere Linux, los otros Nodos no necesariamente.</li>
  <li>Para este tutorial, consideraremos que: a)todos están en Linux, b)su configuración de red se hará manualmente.</li>
</ul>

<h3 id="configuracin-de-nodos-en-ipv6">Configuración de Nodos en IPv6</h3>

<p>Para los nodos de <em>A</em> a <em>E</em>, ejecuta la siguiente secuencia de comandos con permisos de administrador:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">user@A:~# service network-manager stop
user@A:~# /sbin/ip link <span class="nb">set </span>eth0 up
user@A:~# <span class="c"># Replace &quot;::8&quot; depending on which node you&#39;re on.</span>
user@A:~# /sbin/ip address add 2001:db8::8/96 dev eth0
user@A:~# /sbin/ip route add default via 2001:db8::1</code></pre></div>

<h3 id="configuracin-de-nodos-en-ipv4">Configuración de Nodos en IPv4</h3>

<p>Para los nodos de <em>V</em> a <em>Z</em>, ejecuta la siguiente secuencia de comandos con permisos de administrador:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">user@V:~# service network-manager stop
user@V:~# /sbin/ip link <span class="nb">set </span>eth0 up
user@V:~# <span class="c"># Replace &quot;.16&quot; depending on which node you&#39;re on.</span>
user@V:~# /sbin/ip address add 203.0.113.16/24 dev eth0</code></pre></div>

<p>Estos nodos no necesitan una ruta por defecto. Esto es consecuencia de que se encuentran en la misma red junto con el NAT64. Como la dirección 203.0.113.2 estará enmascarando los nodos IPv6, asi que desde <em>V</em> hasta <em>Z</em> piensan que están hablando directamente con <em>T</em>.</p>

<h3 id="configuracin-del-nodo-traductor">Configuración del Nodo Traductor</h3>

<p>Para el Nodo <em>T</em>, ejecuta la siguiente secuencia de comandos con permisos de administrador:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">user@T:~# service network-manager stop
user@T:~# 
user@T:~# /sbin/ip link <span class="nb">set </span>eth0 up
user@T:~# /sbin/ip address add 2001:db8::1/96 dev eth0
user@T:~# 
user@T:~# /sbin/ip link <span class="nb">set </span>eth1 up
user@T:~# /sbin/ip address add 203.0.113.1/24 dev eth1
user@T:~# /sbin/ip address add 203.0.113.2/24 dev eth1
user@T:~# 
user@T:~# ethtool --offload eth0 tso off
user@T:~# ethtool --offload eth0 ufo off
user@T:~# ethtool --offload eth0 gso off
user@T:~# ethtool --offload eth0 gro off
user@T:~# ethtool --offload eth0 lro off
user@T:~# ethtool --offload eth1 tso off
user@T:~# ethtool --offload eth1 ufo off
user@T:~# ethtool --offload eth1 gso off
user@T:~# ethtool --offload eth1 gro off
user@T:~# ethtool --offload eth1 lro off</code></pre></div>

<p>En modo Stateful es especial en el sentido de que el NAT64 necesita por lo menos dos direcciones IPv4 separadas:</p>

<ul>
  <li>Una o más direcciones utilizadas para el trafico local (ej. hacia y desde <em>T</em>). En la configuración de arriba, esta es  203.0.113.1.</li>
  <li>Una o más direcciones utilizadas para la traducción NAT64. Linux necesita estar consciente de éstas por que necesita enviarles una respuesta ARP. En nuestro ejemplo es 203.0.113.2.</li>
</ul>

<p>La necesidad de esta separación es una <em>peculiaridad de Jool</em> y estamos investigando como eliminarla.</p>

<p>Las direcciones de traducción requieren menos prioridad que las del tráfico local para que <em>T</em> no las use por accidente. Una manera de lograr esto, es simplemente añadiendo las direcciones NAT64 después de las direcciones de nodo.</p>

<p>Recuerda que quizá quieras asegurarte de que <em>T</em> puede comunicarse con todos los nodos antes de continuar.</p>

<h2 id="jool">Jool</h2>

<p>Esta es la sintaxis para insertar Jool Stateful NAT64 en el kernel:<br />
(Requieres permiso de administración)</p>

<pre><code>user@T:~# /sbin/modprobe jool \
	[pool6=&lt;IPv6 prefix&gt;] \
	[pool4=&lt;IPv4 prefixes&gt;] \
	[disabled]
</code></pre>

<ul>
  <li>
    <p><code>pool6</code> es el prefijo que el mecanismo de traducción estará adjuntando y removiendo de las direcciones de los paquetes.</p>
  </li>
  <li>
    <p><code>pool4</code> es el subconjunto de direcciones de los nodos que seran utilizadas para la traducción (la longitud del prefijo es /32 por defecto).</p>
  </li>
  <li>
    <p><code>disabled</code>  inicia Jool en modo inactivo.</p>
  </li>
</ul>

<p><code>EAM</code> y <code>pool6791</code> no tienen sentido en modo stateful, y como tal no estan disponibles.</p>

<p>Para nuestra red de ejemplo:</p>

<pre><code>user@T:~# /sbin/modprobe jool pool6=64:ff9b::/96 pool4=203.0.113.2
</code></pre>

<p>Jool escuchará en la dirección <code>203.0.113.2</code> y para los paquetes en IPv4 agrega y remueve el prefijo <code>64:ff9b::/96</code>.</p>

<h2 id="pruebas">Pruebas</h2>

<h3 id="conectividad-de-ipv6-a-ipv4">Conectividad de IPv6 a IPv4</h3>

<p>Haz un ping a <em>V</em> desde <em>C</em>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">user@C:~<span class="nv">$ </span>ping6 64:ff9b::203.0.113.16
PING 64:ff9b::192.0.2.16<span class="o">(</span>64:ff9b::c000:210<span class="o">)</span> <span class="m">56</span> data bytes
<span class="m">64</span> bytes from 64:ff9b::cb00:7110: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nb">time</span><span class="o">=</span>1.13 ms
<span class="m">64</span> bytes from 64:ff9b::cb00:7110: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nb">time</span><span class="o">=</span>4.48 ms
<span class="m">64</span> bytes from 64:ff9b::cb00:7110: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nb">time</span><span class="o">=</span>15.6 ms
<span class="m">64</span> bytes from 64:ff9b::cb00:7110: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nb">time</span><span class="o">=</span>4.89 ms
^C
--- 64:ff9b::203.0.113.16 ping statistics ---
<span class="m">4</span> packets transmitted, <span class="m">4</span> received, 0% packet loss, <span class="nb">time </span>3004ms
rtt min/avg/max/mdev <span class="o">=</span> 1.136/6.528/15.603/5.438 ms</code></pre></div>

<h3 id="conectividad-a-un-web-server-en-ipv4">Conectividad a un Web Server en IPv4</h3>

<p>Agrega un servidor en <em>Z</em> y accesalo desde <em>A</em>:</p>

<p><img src="../images/run-stateful-firefox-4to6.png" alt="Figura 1 - IPv4 TCP desde un nodo IPv6" /></p>

<p>Para saber cómo permitir que los Nodos IPv4 inicien comunicación consulta la sección de lecturas adicionales.</p>

<p>Si algo no funciona, consulta el <a href="faq.html">FAQ</a>.</p>

<h2 id="deteniendo-jool">Deteniendo Jool</h2>

<p>Para detener Jool, emplea de nuevo el comando modprobe usando el parámetro <code>-r</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">user@T:~# /sbin/modprobe -r jool</code></pre></div>

<h2 id="lecturas-adicionales">Lecturas adicionales</h2>

<ol>
  <li>Un nodo IPv4 externo no puede iniciar la comunicación por que el ve a la red IPv6 como una red privada IPv4 que está atrás de un NAT. Para remediar esto, Jool te permite configurar el “redireccionamiento de puertos” (port forwarding). Ingresa <a href="static-bindings.html">aqui</a> si estás interesado.</li>
  <li>Aprende más sobre la <a href="pool4.html">pool IPv4</a>.</li>
  <li>El <a href="dns64.html">documento de DNS64</a> te dirá como configurar un DNS64 para hacer transparente el uso de dirección-prefijo a los usuarios.</li>
  <li>Por favor, lee acerca de <a href="mtu.html">problemas con MTUs</a> antes de seleccionar alguno.</li>
  <li>Hay <a href="mod-run-alternate.html">otra manera de correr el Stateful NAT64</a>. Quizá te ayude a ver las cosas desde una perspectiva más amplia.</li>
</ol>


					</div>
				</div>
			</div>
			<div id="language_selector">
				
					<a href="../en/mod-run-stateful.html">en</a>
				
				|
				
					<span class="selected">es</span>
				
			</div>
			<div style="clear: both;">&nbsp;</div>
		</div>
	</div>

	<div id="footer">
		<div class="logo-tec"><a href="http://www.itesm.mx"><img src="../images/logo-tec.png" alt="logo-tec" /></a></div>
		<div class="logo-nic"><a href="http://www.nicmexico.mx/"><img src="../images/logo-nic.png" alt="logo-nic" /></a></div>
		<p class="legal">&copy;Jool 2015</p>
	</div>

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-44741331-2', 'jool.mx');
	  ga('send', 'pageview');

	</script>
</body>
</html>
